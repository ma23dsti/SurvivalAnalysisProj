---
title: "Survival Analysis Project"
format: pdf
editor: visual
execute:
  message: false
  warning: false
---

Project outline:

-   Introduction
-   Prepare data
-   Short EDA
-   Perform analysis with multiple methods (4-5-6)
-   Chose 2-3
-   Chose what to keep (maximum 9 pages)

# Introduction

In terms of survival analysis, the objective of this project is to determine the "risk" that pets in an animal shelter have of being adopted (or even duration in the shelter), based on different characteristics that are available in the chosen data set. It is worth mentioning that the data contains different outcomes for the animals: adoption, transfer, or no outcome. However, in our case we will only use a dichotomous output indicating whether it was adopted or not. The data ends on February 2, 2018, after which date it is not known what happens to the animals.

We will also analyze how the following variables, when possible to include them, may influence the adoption or non-adoption of the animals.

Data dictionary:

-   id: unique id for each animal
-   age_upon_outcome: age of the animal when the outcome was determined
-   animal_type: cat, dog, or ... something else
-   breed: breed of the animal
-   color: color of the animal
-   date_of_birth: date of birth of the animal
-   datetime: date and time when the outcome was determined
-   name: name of the animal
-   outcome_type: there are three possible outcomes: adoption, transfer, no outcome (euthanized, died)
-   sex: sex of the animal
-   spay_neuter: whether the animal was spayed or neutered: intact or fixed

# Data preparation

## Load necessary libraries and data

```{r}
# Packages for data preparation
library(dplyr)
library(gtsummary)
library(readr)
library(skimr)
library(gt)

# Packages for analyzing survival data
library(survival)
library(survminer)

raw_data <- read_csv("data/train.csv")
```

## EDA

At a quick glance at the data, we observe that in the case of categorical variables we will have to make modifications in order to be able to work with them, for example in the case of breed, color and name we have too many different types or levels, which would be impossible to use them all. The variable name, on the other hand, has a significant number of null values.

```{r}
#| echo: false

#raw_data |> 
#  summary()

skim(raw_data) |>
  filter(skim_type == "character")
```

In order to be able to work with this data, these will be the first modifications we will make:

-   Since the variables `breed` and `color` have too many different combinations, we will remove them from our data, they will not be useful for our models.

-   We have names for 69.8% of the animals, so in order to use it, we will create a dummy variable `has_name`, a variable that indicates that if there is a name or not.

-   Also, we decided to treat the `animal_type` and `sex` variables as factors, so they can enter the model.

-   For the duration data, we have the `age_upon_outcome` which is the difference between `date_of_birth` and `datetime` but this is not numeric, so we create our own variable `time_to_outcome`.

-   We will work with `spay_neuter` as our grouping variable. We would like to verify if there are differences in adoption times if the animal is spay neutered or not. If we have an `Unknown` in the variable, we will encode it as `Intact`, as knowing for sure how the animal has been handled is important.

-   We keep `animal_type`, `sex` and `spay_neuter` as they are, the only modification in this case will be that for `animal_type`, since there are only 5 observations in Livestock, we will join this category to Other. In summary we have a majority of dogs and cats, in sex variable 44% of female, 48% of male and 8% classified as Unknown. In the case of spaying and neutering, we have 68% fixed, 24% intact and 8% classified as Unknown.

```{r}

raw_data <- raw_data |> 
  mutate(has_name = !is.na(name), # If not NA, then it has a name. 
         sex = as.factor(sex),
         time_to_outcome = as.Date(datetime) - date_of_birth,
         spay_neuter = as.factor(if_else(spay_neuter == "Unknown", "Intact", spay_neuter)),
         animal_type = as.factor(if_else(animal_type == "Livestock","Other", animal_type))
         )
```

```{r}
#| eval: false
#| echo: false

raw_data |> 
  count(animal_type) |>
  mutate(prop = round(n / sum(n) * 100,1)) |> 
  gt()
  

raw_data |> 
  count(sex) |>
  mutate(prop = round(n / sum(n) * 100,1)) |> 
  gt()

raw_data |> 
  count(spay_neuter) |>
  mutate(prop = round(n / sum(n) * 100,1)) |> 
  gt()


```

In the case of the output variable, where the possibilities are adopted, unadopted or unknown, we will create a new variable `outcome` for which we take `1` for adoption and `0` for no adoption or unknown.

```{r}
#| echo: false
#| 
raw_data <- raw_data |> 
  mutate(outcome = if_else(outcome_type == "adoption", 1, 0))

raw_data |> 
  count(outcome) |>
  mutate(prop = round(n / sum(n) * 100,1)) |>  
  gt()
```

Finally, since we got some negative values for our variable `time_to_outcome` , which makes no sense as the `date_of_birth` should come before the outcome, we will remove these five observations (5).

```{r}
#| echo: false
raw_data <- raw_data |> 
  filter(time_to_outcome >= 0)
```

Now we chose the variable we will use as a clean data , check that they have the desired formats and do some previous analysis on the variables.

```{r}
#| echo: false

data <- raw_data |> 
  select(id, time_to_outcome, animal_type, has_name, sex, spay_neuter,outcome) |> 
  mutate(id = as.character(id))

dplyr::glimpse(data)

#TODO: add table name
tbl_cross(data, row = spay_neuter, col = outcome,percent = c("row"), digits = 0)|> 
  bold_labels()
```

Within the animals, there is not a difference that seems to be important according to sex, at least not proportionally. In the case of animals with names, more than 70% have been adopted against 26% in the case of those without names. Something similar happens with the animals that have been spayed or neutered, the proportion of adopted animals in this case exceeds 80%, while in the group of those that are not known or have not undergone surgery, the percentage of adopted animals is barely 20%. Lastly, dogs are not only the largest number of animals but also have the highest adoption rate, while among cats and birds there is practically half and half between adoptees and non-adoptees.[^1]

[^1]: The cross tables for the variables `sex`, `animal_type` and `has_name`, see appendix 1.

## Method to take into account the colors

We have too many colors but we could expect this feature to have a significant impact on the choice to adopt or not. We can build some subcategories then, in order to reduce the number of possible values and be able to take into account the embedded information. We try two kind of grouping : by number of colors and by intensity of shade.\

```{r}
#install.packages("stringr")
library(stringr)

# Define a function to count the number of colors
count_colors <- function(color) {
  if (color == "Tricolor") {
    return (3)
  } else { return(str_count(color, "/") + 1)}
}

# Define a function to classify colors by shade intensity
classify_color <- function(color) {
  # Convert color to lowercase to handle case sensitivity
  color <- tolower(color)
  
  # Define categories based on shade intensity
  if (grepl("white|cream|buff|apricot|yellow|fawn|pink", color)) {
    return("Light")
  } else if (grepl("tan|gray|brown|silver|gold|green|blue|orange", color)) {
    return("Medium")
  } else if (grepl("black|chocolate|red|sable|tricolor|calico", color)) {
    return("Dark")
  } else {
    return("Unknown")
  }
}
```

```{r}
# Create new columns in the dataframe with the count of colors and the shade intensity of colors
data2 <- raw_data |>
  mutate(color_count = sapply(color, count_colors),
         color_shade_intens = sapply(color, classify_color)
         )

#Define color_count and color_shade_intens as factor
data2 <- data2 |>
  mutate(color_count = as.factor(color_count),
         color_shade_intens = as.factor(color_shade_intens))

# Display the first few rows of the updated dataset to ensure the new columns are added correctly
head(data2)
```

By looking at the repartition of the enriched dataset, it seems that having extreme color (light or dark) or having more colors increase the chance of adoption.

```{r}
#| echo: false

data2 <- data2 |> 
  select(id, time_to_outcome, animal_type, has_name, sex, spay_neuter,outcome, color_count, color_shade_intens) |> 
  mutate(id = as.character(id))

dplyr::glimpse(data)

#TODO: add table name
tbl_cross(data2, row = color_count, col = outcome,percent = c("row"), digits = 0)|>   bold_labels()

tbl_cross(data2, row = color_shade_intens, col = outcome,percent = c("row"), digits = 0)|> 
  bold_labels()
```

# Statistical Analysis

The next graph is the survival curve and the cumulative hazard function, for this data:

```{r}
#| echo: false

#survival object
so <- survfit(Surv(time_to_outcome, outcome) ~ 1, data =data[,-1] )

par(mfrow=c(1,2))
#TODO: fix this graph
#so |>
#  autoplot() +
#  ylab("S(t)") +
#  xlab("Time")

#Cumulative
ggsurvplot(so, data = data,fun = "cumhaz")

```

Example options given by instructions:

-   nonparametric estimation of survival for one or more groups

-   nonparametric comparison of 2 or more groups

-   semi-parametric Cox regression

## Nonparametric methods for censored data

Using the Kaplan-Meyer estimator (KM) methodology we can see that the median survival time is 749 days (in this particular case the time from birth to adoption, and it's about 2 years). If we estimate the probability of not being adopted when the animal is one year old, we see that this value is 71.9%.
We get similar results with Flemingâˆ’Harrington estimator.

```{r}
fit.KM <- survfit(Surv(time_to_outcome, outcome) ~ 1 , data = data[,-1]) 
fit.KM
fit.NA <- survfit(Surv(time_to_outcome, outcome) ~ 1 , data = data[,-1], type = "fleming-harrington") 
fit.NA

plot(fit.KM, mark.time = TRUE, main = "Kaplan-Meier estimator",
     ylab = 'Survival probability',
     xlab = 'time(days)')
plot(fit.NA, mark.time = TRUE, main = "Flemingâˆ’Harrington estimator",
     ylab = 'Survival probability',
     xlab = 'time(days)')

#estimated probability of not being adopted after 1 year
summary(fit.KM, time = 365)
summary(fit.NA, time = 365)
```

```{r}
#***Other possible graph (Number at risk are also displayed)

## Turn into a data_frame
data_df <- as_data_frame(data)

## Plot
ggsurvplot(survfit(Surv(time_to_outcome, outcome) ~ 1,
                   data = data_df),
           risk.table = TRUE,
           break.time.by = 1000)
```

## Nonparametric comparison of groups

Even if we do not have two groups in the dataset, for example with different treatments, we want to use this technique to analyze, for example, whether or not being part of the females group contributes to being adopted more quickly. So, the null hypothesis or question that we are going to try to answer is if the survival curves generated for the groups are the same, and the alternative hypothesis is that they are different. We will perform the logrank test.

```{r}
#| echo: false

#*** Should not it make more sense to analyse with female and male only ?
#*** => there is no significant difference.
data_feMalOnly <- data[data$sex != "Unknown", ] # Keep Female and Male only.

sex_comp <- survfit(Surv(time_to_outcome, outcome) ~ sex, data = data_feMalOnly)
#sex_comp <- survfit(Surv(time_to_outcome, outcome) ~ sex, data = data)
sex_comp

plot(sex_comp,mark.time = T, lty = 2:3,col=2:3)
#plot(sex_comp,mark.time = T, lty = 2:4,col=2:4)
legend("right", legend=sort(unique(data_feMalOnly$sex)), col=2:4, lty=2:4, horiz=FALSE,  bty='n')
#legend("right", legend=sort(unique(data$sex)), col=2:4, lty=2:4, horiz=FALSE,  bty='n')

# The logrank test
survdiff(Surv(time_to_outcome, outcome) ~ sex, data = data_feMalOnly)
#survdiff(Surv(time_to_outcome, outcome) ~ sex, data = data)

```

As we can see both in the graph and in the logrank test, there is statistical evidence to reject the null hypothesis of equality between curves, and this is due to the fact that although there do not seem to be differences between male and female, in those animals for which the sex is not determined, there do seem to be differences in the time from birth to adoption.

In the `has_name` we get also a difference between the curves and it looks like the adoption goes faster for those animal that don't have a name at the moment of adoption. We can perform the same process with other categorical variables[^2].
> *** It is the other way round. It is also confirmed by the medians. The legend of the graph needs to be fixed by sorting the labels before displaying them.

[^2]: for further information look at Appendix 2

By taking into account the feature color, we get a similar conclusion as the ones reported in the first analysis : color makes statistically a difference (especially, pets having light color seems to be adopted faster). Number of colors hes statistically an impact on the probability to be adopted even if the survival curves look close and similar.

## Semi-parametric multivariate Cox regression

```{r}
cox_model <- coxph(Surv(time_to_outcome, outcome) ~ animal_type + has_name + sex + spay_neuter, data = data)
summary(cox_model)
```

Let's see our predicted survival proportion for the whole data.

```{r}
ggsurvplot(survfit(cox_model), data = data)
```

Now, we can verify how this survival changes depending on the `spay_neuter` variable.

```{r}
# Prediction
spay_neutered_data <- tibble(animal_type = c('Dog', 'Dog'),
                             has_name = c(TRUE,TRUE),
                             sex = c("Male", "Male"),
                             spay_neuter = c('Fixed', 'Intact'))


# Fit a prediction
fit <- survfit(cox_model, newdata = spay_neutered_data)
ggsurvplot(fit, data = data, conf.int = TRUE,
            legend.labs = c("spay_neuter = Fixed", "spay_neuter = Intact")) 
```

As expected, animal which were spay neutered, have shorter survival time, that means they were adopted faster.

About the colors, Light/Dark shade intensity makes statistically a significant difference to be adopted faster comparing to pets having an Unknown intensity (~ 10% more chances).
Having 1 or 3 colors does not seem to make a difference but, having 2 colors comparing to 1, would increase the chances to be adopted by ~ 10%.
Having 2 colors makes statistically a significant difference comparing to having 1 color, by increasing the chance by 10%. Furthermore, taking into account the color improve the concordance of the model (from 0.629 to 0.632)[^3].

[^3]: for further information look at Appendix 3

# Model diagnostics

## Martingale residuals

The residuals are not well formed. Furthermore, the plot of proportionality of the hazards does not look good : H0 (beta = beta(t)) is rejected.
The model would not be validated although the results of the analyses of the model are consistent to what we could have expected. [^4].

[^4]: for further information look at Appendix 4

```{r}
data$residual <- residuals(cox_model, type = "martingale")

par(mfrow = c(1, 3), mar = c(4.2, 2, 2, 2))
with(data, {

  plot(time_to_outcome, residual)
  lines(lowess(time_to_outcome, residual), lwd = 2)

  plot(residual ~ animal_type)

  plot(residual ~ spay_neuter)

})
```

# Appendix

## Appendix 1: cross tables

```{r}
#TODO: add tables names
tbl_cross(data, row = has_name, col = outcome,percent = c("row"), digits = 0)|> 
  bold_labels()

tbl_cross(data, row = sex, col = outcome,percent = c("col"), digits = 0)|> 
  bold_labels()

tbl_cross(data, row = animal_type, col = outcome,percent = c("row"), digits = 0)|> 
  bold_labels()
```

## Appendix 2: Nonparametric comparison of groups

Variable `has_name`

```{r}

has_name_comp <- survfit(Surv(time_to_outcome, outcome) ~ has_name, data = data)

has_name_comp  

plot(has_name_comp,mark.time = T, lty = 2:3,col=2:3) 
legend("right", legend=sort(unique(data$has_name)), col=2:3, lty=2:3, horiz=FALSE,  bty='n') 
```

Variable `animal_type`

```{r}
type_comp <- survfit(Surv(time_to_outcome, outcome) ~ animal_type, data = data)
type_comp

plot(type_comp,mark.time = T, lty = 2:6,col=2:6)
legend("right", legend=sort(unique(data$animal_type)), col=2:6, lty=2:6, horiz=FALSE,  bty='n')

# The logrank test
survdiff(Surv(time_to_outcome, outcome) ~ animal_type, data = data)
```

Variable `spay_neuter`

```{r}
spay_neuter_comp <- survfit(Surv(time_to_outcome, outcome) ~ spay_neuter, data = data)
spay_neuter_comp

plot(spay_neuter_comp,mark.time = T, lty = 2:3,col=2:3)
legend("right", legend=sort(unique(data$spay_neuter)), col=2:3, lty=2:3, horiz=FALSE,  bty='n')

# The logrank test
survdiff(Surv(time_to_outcome, outcome) ~ spay_neuter, data = data)
```

```{r}
#| echo: false

color_count_comp <- survfit(Surv(time_to_outcome, outcome) ~ color_count, data = data2)
color_count_comp

plot(color_count_comp,mark.time = T, lty = 2:4,col=2:4)
legend("right", legend=sort(unique(data2$color_count)), col=2:4, lty=2:4, horiz=FALSE,  bty='n')

# The logrank test
survdiff(Surv(time_to_outcome, outcome) ~ color_count, data = data2)
```

```{r}
#| echo: false

color_shade_intens_comp <- survfit(Surv(time_to_outcome, outcome) ~ color_shade_intens, data = data2)
color_shade_intens_comp

plot(color_shade_intens_comp,mark.time = T, lty = 2:4,col=2:4)
legend("right", legend=sort(unique(data2$color_shade_intens)), col=2:4, lty=2:4, horiz=FALSE,  bty='n')

# The logrank test
survdiff(Surv(time_to_outcome, outcome) ~ color_shade_intens, data = data2)
```

## Appendix 3: Semi-parametric multivariate Cox regression

```{r}
data2 <- mutate(data2,
                animal_type  = relevel(factor(animal_type ), ref = "Other"),
                color_shade_intens = relevel(factor(color_shade_intens), ref = "Unknown"))
cox_model2 <- coxph(Surv(time_to_outcome, outcome) ~ animal_type + has_name + sex + spay_neuter + color_count + color_shade_intens, data = data2)
summary(cox_model2)
```

Appendix 4: Model validation

```{r}
data2$residual <- residuals(cox_model2, type = "martingale")

par(mfrow = c(1, 3), mar = c(4.2, 2, 2, 2))
with(data2, {

  plot(time_to_outcome, residual)
  lines(lowess(time_to_outcome, residual), lwd = 2)

  plot(residual ~ animal_type)

  plot(residual ~ spay_neuter)

})
```

## Proportionality of hazards

The plots do not look good.\
H0 (beta = beta(t)) is rejected.

```{r}
residual.sch <- cox.zph(cox_model)
residual.sch
plot(residual.sch)
```
